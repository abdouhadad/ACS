<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.StoredProcedureOraclev10g" name="PROCESS_STAT_MAIL" directorySegmentName="seg_0" id="CED293F8-1BF0-B3B9-7D42-3F51D23D5FB1">
<sourceConnName>osd11g</sourceConnName>
<sourceObjSchema>OSD</sourceObjSchema>
<sourceObjName>PROCESS_STAT_MAIL</sourceObjName>
<createdBy>Administrator</createdBy>
<createdTime>2014-12-02 09:16:58 UTC</createdTime>
<ownerDesignName>ACS1.2</ownerDesignName>
<owner>C5730B64-FB4D-9F2E-CCB9-0672373953FB</owner>
<source>CREATE OR REPLACE procedure     OSD.PROCESS_STAT_MAIL is&lt;br/&gt;&lt;br/&gt;   cursor dept1 is   select m.department_no, department_name&lt;br/&gt;                     from OSD.MAIL_HOUR1 m, main.departments d&lt;br/&gt;                     where m.department_no = d.department_no&lt;br/&gt;                     group by m.department_no, department_name&lt;br/&gt;                     order by department_no ;&lt;br/&gt;                     &lt;br/&gt;   cursor dept2 is   select m.department_no, department_name&lt;br/&gt;                     from OSD.MAIL_HOUR2 m, main.departments d&lt;br/&gt;                     where m.department_no = d.department_no&lt;br/&gt;                     group by m.department_no, department_name&lt;br/&gt;                     order by department_no ; &lt;br/&gt;                                                                &lt;br/&gt;   cursor dept3 is   select m.department_no, department_name&lt;br/&gt;                     from OSD.MAIL_HOUR3 m, main.departments d&lt;br/&gt;                     where m.department_no = d.department_no&lt;br/&gt;                     group by m.department_no, department_name&lt;br/&gt;                     order by department_no ;                         &lt;br/&gt;   ----------------------------------------------------------&lt;br/&gt;   e_no                     number;&lt;br/&gt;   e_mail                   varchar2(100);&lt;br/&gt;   dept_pro                 clob:=&apos;&apos;;&lt;br/&gt;   department_pro           clob:=&apos;&apos;;&lt;br/&gt;   temp1                    clob;&lt;br/&gt;   temp2                    clob;&lt;br/&gt;   temp3                    clob:=&apos;&apos;;&lt;br/&gt;   temp4                    clob:=&apos;&apos;;   &lt;br/&gt;   m_id                     number ; &lt;br/&gt;   v_count                  number ;&lt;br/&gt;    &lt;br/&gt;begin &lt;br/&gt;&lt;br/&gt;    DBMS_LOB.createtemporary (temp1 , TRUE);  &lt;br/&gt;    DBMS_LOB.createtemporary (temp2 , TRUE);  &lt;br/&gt;    DBMS_LOB.createtemporary (temp3 , TRUE);&lt;br/&gt;    DBMS_LOB.createtemporary (temp4 , TRUE);&lt;br/&gt;    &lt;br/&gt;    ------------- 1 Day  --------------------------------------------------------------------------------------------------------------------------                                            &lt;br/&gt;    for i in dept1  loop&lt;br/&gt;           &lt;br/&gt;        department_pro :=&apos;&apos;;&lt;br/&gt;        dept_pro :=&apos;&apos;;&lt;br/&gt;        temp1 :=&apos;&apos;;&lt;br/&gt;        temp2 :=&apos;&apos;;       &lt;br/&gt;        temp3 :=&apos;&apos;;&lt;br/&gt;        temp4 :=&apos;&apos;;&lt;br/&gt;        &lt;br/&gt;        department_pro :=&apos;&lt;table width=&quot;100%&quot; border=&quot;1&quot; bordercolor=&quot;#000000&quot; style=&quot;border-collapse:collapse;&quot;&gt;&apos;;         &lt;br/&gt;                &lt;br/&gt;        for ii in ( select dept_code, department_name dept_name&lt;br/&gt;                    from OSD.MAIL_HOUR1 m, main.departments d &lt;br/&gt;                    where m.dept_code = d.department_no &lt;br/&gt;                    and m.department_no = i.department_no&lt;br/&gt;                    group by m.dept_code, department_name&lt;br/&gt;                    order by 1, dept_code  )&lt;br/&gt;&lt;br/&gt;         loop &lt;br/&gt;           &lt;br/&gt;            dept_pro :=&apos;&apos;;&lt;br/&gt;            dept_pro :=&apos;&lt;table width=&quot;100%&quot; border=&quot;1&quot; bordercolor=&quot;#000000&quot; style=&quot;border-collapse:collapse;&quot;&gt;&apos;;             &lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;            ---------- department_pro ------------&lt;br/&gt;            temp1 := &apos; &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #ddd&quot; colspan=&quot;2&quot; valign=&quot;center&quot;&gt; ??????? ?????? ????? :&apos;||ii.dept_name||&apos;&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&lt;br/&gt;                       &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #eee&quot;&gt;??? ?????&lt;/th&gt;&lt;th style=&quot;background: #eee&quot;&gt;???????&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&apos;; &lt;br/&gt;            dbms_lob.append(department_pro,temp1); &lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;            ---------- dept_pro ------------&lt;br/&gt;            temp2 := &apos; &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #ddd&quot; colspan=&quot;2&quot; valign=&quot;center&quot;&gt; ??????? ?????? ????? :&apos;||ii.dept_name||&apos;&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&lt;br/&gt;                       &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #eee&quot;&gt;??? ?????&lt;/th&gt;&lt;th style=&quot;background: #eee&quot;&gt;???????&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&apos;;&lt;br/&gt;            dbms_lob.append(dept_pro, temp2);&lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;            ------------  process_no data ----------------------------------&lt;br/&gt;            for iii in (select process_no, subject&lt;br/&gt;                        from OSD.MAIL_HOUR1 m, main.departments d &lt;br/&gt;                        where m.dept_code = d.department_no &lt;br/&gt;                        and m.dept_code = ii.dept_code&lt;br/&gt;                        and m.department_no = i.department_no&lt;br/&gt;                        order by 1 )&lt;br/&gt;             loop   &lt;br/&gt;                 &lt;br/&gt;                 temp3 := &apos; &lt;tr&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.process_no||&apos; &lt;/td&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.subject||&apos; &lt;/td&gt;&lt;br/&gt;                            &lt;/tr&gt; &apos;;                                                                                                               &lt;br/&gt;                 dbms_lob.append(department_pro, temp3);  &lt;br/&gt;&lt;br/&gt;                         &lt;br/&gt;                 temp4 := &apos; &lt;tr&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.process_no||&apos; &lt;/td&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.subject||&apos; &lt;/td&gt;&lt;br/&gt;                            &lt;/tr&gt; &apos;;&lt;br/&gt;                 dbms_lob.append(dept_pro, temp4);&lt;br/&gt;                                                                 &lt;br/&gt;                 update osd.process_status set mail_flag = 1 where process_no = iii.process_no;  &lt;br/&gt;&lt;br/&gt;             end loop;  -- iii -----------------------------------------------------------------&lt;br/&gt;            &lt;br/&gt;            dept_pro  := dept_pro||&apos;&lt;/table&gt;&apos;;&lt;br/&gt;            &lt;br/&gt;            ---------- dept_code send ------------            &lt;br/&gt;            for xx in ( select emp_no, emp_mail   into e_no, e_mail &lt;br/&gt;                        from hrms.imarah_email &lt;br/&gt;                        where nvl(emp_no,0) in  ( select employee_no &lt;br/&gt;                                                  from hrms.employees  &lt;br/&gt;                                                  where current_dept = ii.dept_code&lt;br/&gt;                                                  and postion_type = 6 -- ???? ?????   &lt;br/&gt;                                                  and emp_last_status not in (16,17)))  -- ????? ?? ????? ?????  &lt;br/&gt;             loop&lt;br/&gt;             &lt;br/&gt;               lock table p9.mailer IN  EXCLUSIVE  MODE;&lt;br/&gt;               select max(id)+1  into  m_id&lt;br/&gt;               from p9.mailer;&lt;br/&gt;                &lt;br/&gt;               insert into p9.mailer&lt;br/&gt;                        (id,   m_date, employee_no,         type,       email_to,                   subject,                  message, status)&lt;br/&gt;                 values (m_id,  sysdate, nvl(xx.emp_no,0),  &apos;Dept1&apos;,    nvl(xx.emp_mail,&apos;@&apos;),     &apos;??????? ?? ????? ???1???&apos;, &lt;br/&gt;                &apos;??? ????????? ?? ??? ??? ??????? ???? ?? ??? ??? ????? ???  &apos;||&lt;br/&gt;                chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||dept_pro , 1);&lt;br/&gt;                   &lt;br/&gt;                commit; &lt;br/&gt;                &lt;br/&gt;             end loop;     &lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;         end loop; -- ii ----------------------------------------------------------------------------------&lt;br/&gt;         &lt;br/&gt;         department_pro := department_pro||&apos;&lt;/table&gt;&apos;;            &lt;br/&gt;&lt;br/&gt;        ------------ department send ---------------                  &lt;br/&gt;        select count(*) into v_count &lt;br/&gt;        from osd.mail_hour11 -- this view just for count &lt;br/&gt;        where department_no = i.department_no;&lt;br/&gt;         &lt;br/&gt;        if v_count &gt; 0 then&lt;br/&gt;            for x in ( select emp_no, emp_mail   into e_no, e_mail &lt;br/&gt;                       from hrms.imarah_email &lt;br/&gt;                       where nvl(emp_no,0) in  ( select employee_no &lt;br/&gt;                                                 from hrms.employees  &lt;br/&gt;                                                 where current_dept = i.department_no  &lt;br/&gt;                                                 and postion_type = 6 -- ???? ?????   &lt;br/&gt;                                                 and emp_last_status not in (16,17)))  &lt;br/&gt;             loop&lt;br/&gt;&lt;br/&gt;               lock table p9.mailer IN  EXCLUSIVE  MODE;&lt;br/&gt;               select max(id)+1  into  m_id&lt;br/&gt;               from p9.mailer;&lt;br/&gt;               &lt;br/&gt;               insert into p9.mailer&lt;br/&gt;                        (id,   m_date, employee_no,         type,       email_to,                   subject,                  message, status)&lt;br/&gt;                 values (m_id,  sysdate, nvl(x.emp_no,0),    &apos;Depart1&apos;,  nvl(x.emp_mail,&apos;@&apos;),        &apos;??????? ?? ????? ???1???&apos;, &lt;br/&gt;                &apos;??? ????????? ?? ??? ??? ??????? ???? ?? ??? ??? ????? ???  &apos;||&lt;br/&gt;                chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||department_pro , 1);&lt;br/&gt;                   &lt;br/&gt;                commit; &lt;br/&gt;                &lt;br/&gt;             end loop;     &lt;br/&gt;            &lt;br/&gt;            ----  yahya email &lt;br/&gt;            lock table p9.mailer IN   EXCLUSIVE  MODE;&lt;br/&gt;            select max(id)+1  into  m_id&lt;br/&gt;            from p9.mailer;&lt;br/&gt;            &lt;br/&gt;            insert into p9.mailer&lt;br/&gt;                    (id,   m_date, employee_no,         type,          email_to,                   subject,                  message, status)&lt;br/&gt;            values  (m_id,  sysdate, 0,                 &apos;Depart1&apos;,  &apos;yjabri@makkah.gov.sa&apos;,        &apos;??????? ?? ????? ???1???&apos;, &lt;br/&gt;            &apos;??? ????????? ?? ??? ??? ??????? ???? ?? ??? ??? ????? ???  &apos;||&lt;br/&gt;            chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||department_pro , 0);&lt;br/&gt;            &lt;br/&gt;            commit;&lt;br/&gt;            &lt;br/&gt;        end if;&lt;br/&gt;        &lt;br/&gt;    end loop;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;    ------------- 2 Days ------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;       &lt;br/&gt;    for i in dept2  loop&lt;br/&gt;         &lt;br/&gt;        department_pro :=&apos;&apos;;&lt;br/&gt;        dept_pro :=&apos;&apos;;&lt;br/&gt;        temp1 :=&apos;&apos;;&lt;br/&gt;        temp2 :=&apos;&apos;;       &lt;br/&gt;        temp3 :=&apos;&apos;;&lt;br/&gt;        temp4 :=&apos;&apos;;&lt;br/&gt;        &lt;br/&gt;        department_pro :=&apos;&lt;table width=&quot;100%&quot; border=&quot;1&quot; bordercolor=&quot;#000000&quot; style=&quot;border-collapse:collapse;&quot;&gt;&apos;;         &lt;br/&gt;                &lt;br/&gt;        for ii in ( select dept_code, department_name dept_name&lt;br/&gt;                    from OSD.MAIL_HOUR2 m, main.departments d &lt;br/&gt;                    where m.dept_code = d.department_no &lt;br/&gt;                    and m.department_no = i.department_no&lt;br/&gt;                    group by m.dept_code, department_name&lt;br/&gt;                    order by 1, dept_code  )&lt;br/&gt;&lt;br/&gt;         loop &lt;br/&gt;           &lt;br/&gt;            dept_pro :=&apos;&apos;;&lt;br/&gt;            dept_pro :=&apos;&lt;table width=&quot;100%&quot; border=&quot;1&quot; bordercolor=&quot;#000000&quot; style=&quot;border-collapse:collapse;&quot;&gt;&apos;;             &lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;            ---------- department_pro ------------&lt;br/&gt;            temp1 := &apos; &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #ddd&quot; colspan=&quot;2&quot; valign=&quot;center&quot;&gt; ??????? ?????? ????? :&apos;||ii.dept_name||&apos;&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&lt;br/&gt;                       &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #eee&quot;&gt;??? ?????&lt;/th&gt;&lt;th style=&quot;background: #eee&quot;&gt;???????&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&apos;; &lt;br/&gt;            dbms_lob.append(department_pro,temp1); &lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;            ---------- dept_pro ------------&lt;br/&gt;            temp2 := &apos; &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #ddd&quot; colspan=&quot;2&quot; valign=&quot;center&quot;&gt; ??????? ?????? ????? :&apos;||ii.dept_name||&apos;&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&lt;br/&gt;                       &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #eee&quot;&gt;??? ?????&lt;/th&gt;&lt;th style=&quot;background: #eee&quot;&gt;???????&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&apos;;&lt;br/&gt;            dbms_lob.append(dept_pro, temp2);&lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;                ------------  process_no data ----------------------------------&lt;br/&gt;                for iii in (select process_no, subject&lt;br/&gt;                            from OSD.MAIL_HOUR2 m, main.departments d &lt;br/&gt;                            where m.dept_code = d.department_no &lt;br/&gt;                            and m.dept_code = ii.dept_code&lt;br/&gt;                            and m.department_no = i.department_no&lt;br/&gt;                            order by 1 )&lt;br/&gt;                loop   &lt;br/&gt;                 &lt;br/&gt;                 temp3 := &apos; &lt;tr&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.process_no||&apos; &lt;/td&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.subject||&apos; &lt;/td&gt;&lt;br/&gt;                            &lt;/tr&gt; &apos;;                                                                                                               &lt;br/&gt;                  dbms_lob.append(department_pro, temp3);  &lt;br/&gt;&lt;br/&gt;                     &lt;br/&gt;                  temp4 := &apos; &lt;tr&gt;&lt;br/&gt;                                &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.process_no||&apos; &lt;/td&gt;&lt;br/&gt;                                &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.subject||&apos; &lt;/td&gt;&lt;br/&gt;                             &lt;/tr&gt; &apos;;&lt;br/&gt;                   dbms_lob.append(dept_pro, temp4);&lt;br/&gt;                                             &lt;br/&gt;                             &lt;br/&gt;                   update osd.process_status set mail_flag = 2 where process_no = iii.process_no;  &lt;br/&gt;&lt;br/&gt;                end loop;  -- iii -----------------------------------------------------------------&lt;br/&gt;            &lt;br/&gt;             dept_pro  := dept_pro||&apos;&lt;/table&gt;&apos;;&lt;br/&gt;            &lt;br/&gt;            ---------- dept_code send ------------                       &lt;br/&gt;            for xx in ( select emp_no, emp_mail   into e_no, e_mail &lt;br/&gt;                        from hrms.imarah_email &lt;br/&gt;                        where nvl(emp_no,0) in  ( select employee_no from hrms.employees &lt;br/&gt;                                                  where current_dept = ii.dept_code&lt;br/&gt;                                                  and postion_type in (6,10) -- ???? ????? ? ???? ??? &lt;br/&gt;                                                  and emp_last_status not in (16,17) )) &lt;br/&gt;            loop&lt;br/&gt;&lt;br/&gt;               lock table p9.mailer IN   EXCLUSIVE  MODE;&lt;br/&gt;               select max(id)+1  into  m_id&lt;br/&gt;               from p9.mailer;&lt;br/&gt;               &lt;br/&gt;               insert into p9.mailer &lt;br/&gt;                       (id,   m_date, employee_no,          type,       email_to,               subject,                   message, status)&lt;br/&gt;               values  (m_id, sysdate, nvl(xx.emp_no,0),    &apos;Dept2&apos;,     nvl(xx.emp_mail,&apos;@&apos;),    &apos;??????? ?? ????? ???2???&apos;, &lt;br/&gt;               &apos;??? ????????? ??? ??? ??????? ???? ?? ????? ??? ????? ???  ?????? ???? ?????? ???????? ??? ?????? ???? ????  &apos;||&lt;br/&gt;               chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||dept_pro , 1);&lt;br/&gt;               &lt;br/&gt;               commit;   &lt;br/&gt;                                                 &lt;br/&gt;            end loop;&lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;         end loop;&lt;br/&gt;         &lt;br/&gt;         department_pro := department_pro||&apos;&lt;/table&gt;&apos;;            &lt;br/&gt;&lt;br/&gt;        ------------ department send ---------------                        &lt;br/&gt;        select count(*) into v_count &lt;br/&gt;        from osd.mail_hour22 -- this view just for count &lt;br/&gt;        where department_no = i.department_no;&lt;br/&gt;         &lt;br/&gt;        if v_count &gt; 0 then&lt;br/&gt;            &lt;br/&gt;            for xx in ( select emp_no, emp_mail   into e_no, e_mail &lt;br/&gt;                        from hrms.imarah_email &lt;br/&gt;                        where nvl(emp_no,0) in  ( select employee_no from hrms.employees &lt;br/&gt;                                                  where current_dept = i.department_no&lt;br/&gt;                                                  and postion_type in (6,10) -- ???? ????? ? ???? ??? &lt;br/&gt;                                                  and emp_last_status not in (16,17) )) &lt;br/&gt;            loop&lt;br/&gt;               &lt;br/&gt;               lock table p9.mailer IN   EXCLUSIVE  MODE;&lt;br/&gt;               select max(id)+1  into  m_id&lt;br/&gt;               from p9.mailer;&lt;br/&gt;               &lt;br/&gt;               insert into p9.mailer &lt;br/&gt;                       (id,   m_date, employee_no,          type,       email_to,               subject,                   message, status)&lt;br/&gt;               values  (m_id, sysdate, nvl(xx.emp_no,0),   &apos;Depart2&apos;,          nvl(xx.emp_mail,&apos;@&apos;),    &apos;??????? ?? ????? ???2???&apos;, &lt;br/&gt;               &apos;??? ????????? ??? ??? ??????? ???? ?? ????? ??? ????? ???  ?????? ???? ?????? ???????? ??? ?????? ???? ????  &apos;||&lt;br/&gt;               chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||department_pro , 1);&lt;br/&gt;               &lt;br/&gt;               commit;   &lt;br/&gt;                                                 &lt;br/&gt;            end loop;&lt;br/&gt;&lt;br/&gt;        &lt;br/&gt;            ----  yahya email &lt;br/&gt;            lock table p9.mailer IN   EXCLUSIVE  MODE;&lt;br/&gt;            select max(id)+1  into  m_id&lt;br/&gt;            from p9.mailer;&lt;br/&gt;            &lt;br/&gt;            insert into p9.mailer &lt;br/&gt;                   (id,   m_date, employee_no,          type,       email_to,               subject,                   message, status)&lt;br/&gt;            values  (m_id, sysdate, 0,                  &apos;Depart2&apos;,  &apos;YJabri@makkah.gov.sa&apos;,    &apos;??????? ?? ????? ???2???&apos;, &lt;br/&gt;            &apos;??? ????????? ??? ??? ??????? ???? ?? ????? ??? ????? ???  ?????? ???? ?????? ???????? ??? ?????? ???? ????  &apos;||&lt;br/&gt;            chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||department_pro , 0);&lt;br/&gt;            &lt;br/&gt;            commit;&lt;br/&gt;            &lt;br/&gt;        end if;&lt;br/&gt;        &lt;br/&gt;    end loop;    &lt;br/&gt;&lt;br/&gt;&lt;br/&gt;    ------------- 3 Days ------------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;    &lt;br/&gt;    for i in dept3  loop&lt;br/&gt;       &lt;br/&gt;        department_pro :=&apos;&apos;;&lt;br/&gt;        dept_pro :=&apos;&apos;;&lt;br/&gt;        temp1 :=&apos;&apos;;&lt;br/&gt;        temp2 :=&apos;&apos;;       &lt;br/&gt;        temp3 :=&apos;&apos;;&lt;br/&gt;        temp4 :=&apos;&apos;;&lt;br/&gt;        &lt;br/&gt;        department_pro :=&apos;&lt;table width=&quot;100%&quot; border=&quot;1&quot; bordercolor=&quot;#000000&quot; style=&quot;border-collapse:collapse;&quot;&gt;&apos;;         &lt;br/&gt;                &lt;br/&gt;        for ii in ( select dept_code, department_name dept_name&lt;br/&gt;                    from OSD.MAIL_HOUR3 m, main.departments d &lt;br/&gt;                    where m.dept_code = d.department_no &lt;br/&gt;                    and m.department_no = i.department_no&lt;br/&gt;                    group by m.dept_code, department_name&lt;br/&gt;                    order by 1, dept_code  )&lt;br/&gt;&lt;br/&gt;         loop &lt;br/&gt;           &lt;br/&gt;            dept_pro :=&apos;&apos;;&lt;br/&gt;            dept_pro :=&apos;&lt;table width=&quot;100%&quot; border=&quot;1&quot; bordercolor=&quot;#000000&quot; style=&quot;border-collapse:collapse;&quot;&gt;&apos;;             &lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;            ---------- department_pro ------------&lt;br/&gt;            temp1 := &apos; &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #ddd&quot; colspan=&quot;2&quot; valign=&quot;center&quot;&gt; ??????? ?????? ????? :&apos;||ii.dept_name||&apos;&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&lt;br/&gt;                       &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #eee&quot;&gt;??? ?????&lt;/th&gt;&lt;th style=&quot;background: #eee&quot;&gt;???????&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&apos;; &lt;br/&gt;            dbms_lob.append(department_pro,temp1); &lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;            ---------- dept_pro ------------&lt;br/&gt;            temp2 := &apos; &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #ddd&quot; colspan=&quot;2&quot; valign=&quot;center&quot;&gt; ??????? ?????? ????? :&apos;||ii.dept_name||&apos;&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&lt;br/&gt;                       &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #eee&quot;&gt;??? ?????&lt;/th&gt;&lt;th style=&quot;background: #eee&quot;&gt;???????&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&apos;;&lt;br/&gt;            dbms_lob.append(dept_pro, temp2);&lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;                ------------  process_no data ----------------------------------&lt;br/&gt;                for iii in (select process_no, subject&lt;br/&gt;                            from OSD.MAIL_HOUR3 m, main.departments d &lt;br/&gt;                            where m.dept_code = d.department_no &lt;br/&gt;                            and m.dept_code = ii.dept_code&lt;br/&gt;                            and m.department_no = i.department_no&lt;br/&gt;                            order by 1 )&lt;br/&gt;                loop   &lt;br/&gt;                 &lt;br/&gt;                 temp3 := &apos; &lt;tr&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.process_no||&apos; &lt;/td&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.subject||&apos; &lt;/td&gt;&lt;br/&gt;                            &lt;/tr&gt; &apos;;                                                                                                               &lt;br/&gt;                  dbms_lob.append(department_pro, temp3);  &lt;br/&gt;&lt;br/&gt;                     &lt;br/&gt;                  temp4 := &apos; &lt;tr&gt;&lt;br/&gt;                                &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.process_no||&apos; &lt;/td&gt;&lt;br/&gt;                                &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.subject||&apos; &lt;/td&gt;&lt;br/&gt;                             &lt;/tr&gt; &apos;;&lt;br/&gt;                   dbms_lob.append(dept_pro, temp4);&lt;br/&gt;                                             &lt;br/&gt;                             &lt;br/&gt;                   update osd.process_status set mail_flag = 3 where process_no = iii.process_no;  &lt;br/&gt;&lt;br/&gt;                end loop;  -- iii -----------------------------------------------------------------&lt;br/&gt;            &lt;br/&gt;             dept_pro  := dept_pro||&apos;&lt;/table&gt;&apos;;&lt;br/&gt;            &lt;br/&gt;&lt;br/&gt;            ---------- dept_code send ------------                       &lt;br/&gt;             for x in ( select emp_no, emp_mail   into e_no, e_mail &lt;br/&gt;                        from hrms.imarah_email &lt;br/&gt;                        where emp_no in   ( select employee_no &lt;br/&gt;                                            from hrms.employees &lt;br/&gt;                                            where current_dept = i.department_no &lt;br/&gt;                                            and postion_type in (6, 10) -- ???? ????? ????? ??? &lt;br/&gt;                                            and emp_last_status not in (16,17) )) &lt;br/&gt;             loop&lt;br/&gt;               &lt;br/&gt;               lock table p9.mailer IN   EXCLUSIVE  MODE;&lt;br/&gt;               select max(id)+1  into  m_id&lt;br/&gt;               from p9.mailer;               &lt;br/&gt;               &lt;br/&gt;               insert into p9.mailer &lt;br/&gt;                       (id,   m_date, employee_no,       type,      email_to,               subject,                      message, status)&lt;br/&gt;               values  (m_id, sysdate, nvl(x.emp_no,0),  &apos;Dept3&apos;,        nvl(x.emp_mail,&apos;@&apos;),   &apos;??????? ?? ????? ?? 3????&apos;, &lt;br/&gt;                 &apos;??? ????????? ??? ??? ??????? ???? ?? ????? ???? ??? ????? ???  &apos;||&lt;br/&gt;                 chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||dept_pro , 1);&lt;br/&gt;                &lt;br/&gt;                commit;                                    &lt;br/&gt;              &lt;br/&gt;             end loop;&lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;         end loop;&lt;br/&gt;         &lt;br/&gt;         department_pro := department_pro||&apos;&lt;/table&gt;&apos;;            &lt;br/&gt;&lt;br/&gt;        ------------ department send ---------------                        &lt;br/&gt;        select count(*) into v_count &lt;br/&gt;        from osd.mail_hour33  -- this view just for count &lt;br/&gt;        where department_no = i.department_no;&lt;br/&gt;         &lt;br/&gt;        if v_count &gt; 0 then&lt;br/&gt;            &lt;br/&gt;             for x in ( select emp_no, emp_mail   into e_no, e_mail &lt;br/&gt;                        from hrms.imarah_email &lt;br/&gt;                        where emp_no in   ( select employee_no &lt;br/&gt;                                            from hrms.employees &lt;br/&gt;                                            where current_dept = i.department_no &lt;br/&gt;                                            and postion_type in (6, 10) -- ???? ????? ????? ??? &lt;br/&gt;                                            and emp_last_status not in (16,17) )) &lt;br/&gt;             loop&lt;br/&gt;                &lt;br/&gt;               lock table p9.mailer IN   EXCLUSIVE  MODE;&lt;br/&gt;               select max(id)+1  into  m_id&lt;br/&gt;               from p9.mailer;               &lt;br/&gt;               &lt;br/&gt;               insert into p9.mailer &lt;br/&gt;                       (id,   m_date, employee_no,       type,      email_to,               subject,                      message, status)&lt;br/&gt;               values  (m_id, sysdate, nvl(x.emp_no,0),  &apos;Depart3&apos;,  nvl(x.emp_mail,&apos;@&apos;),   &apos;??????? ?? ????? ?? 3????&apos;, &lt;br/&gt;                 &apos;??? ????????? ??? ??? ??????? ???? ?? ????? ???? ??? ????? ???  &apos;||&lt;br/&gt;                 chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||department_pro , 1);&lt;br/&gt;                &lt;br/&gt;                commit;                                    &lt;br/&gt;              &lt;br/&gt;             end loop;&lt;br/&gt;&lt;br/&gt;        &lt;br/&gt;            ----  yahya email &lt;br/&gt;            lock table p9.mailer IN   EXCLUSIVE  MODE;&lt;br/&gt;            select max(id)+1  into  m_id&lt;br/&gt;            from p9.mailer;&lt;br/&gt;            &lt;br/&gt;            insert into p9.mailer &lt;br/&gt;                   (id,   m_date, employee_no,       type,      email_to,               subject,                      message, status)&lt;br/&gt;            values  (m_id, sysdate, 0,               &apos;Depart3&apos;,       &apos;YJabri@makkah.gov.sa&apos;,   &apos;??????? ?? ????? ?? 3????&apos;, &lt;br/&gt;             &apos;??? ????????? ??? ??? ??????? ???? ?? ????? ???? ??? ????? ???  &apos;||&lt;br/&gt;            chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||department_pro , 0);&lt;br/&gt;           &lt;br/&gt;            commit;&lt;br/&gt;            &lt;br/&gt;        end if;&lt;br/&gt;        &lt;br/&gt;    end loop;    &lt;br/&gt;    &lt;br/&gt;end;</source>
<body>CREATE OR REPLACE procedure     OSD.PROCESS_STAT_MAIL is&lt;br/&gt;&lt;br/&gt;   cursor dept1 is   select m.department_no, department_name&lt;br/&gt;                     from OSD.MAIL_HOUR1 m, main.departments d&lt;br/&gt;                     where m.department_no = d.department_no&lt;br/&gt;                     group by m.department_no, department_name&lt;br/&gt;                     order by department_no ;&lt;br/&gt;                     &lt;br/&gt;   cursor dept2 is   select m.department_no, department_name&lt;br/&gt;                     from OSD.MAIL_HOUR2 m, main.departments d&lt;br/&gt;                     where m.department_no = d.department_no&lt;br/&gt;                     group by m.department_no, department_name&lt;br/&gt;                     order by department_no ; &lt;br/&gt;                                                                &lt;br/&gt;   cursor dept3 is   select m.department_no, department_name&lt;br/&gt;                     from OSD.MAIL_HOUR3 m, main.departments d&lt;br/&gt;                     where m.department_no = d.department_no&lt;br/&gt;                     group by m.department_no, department_name&lt;br/&gt;                     order by department_no ;                         &lt;br/&gt;   ----------------------------------------------------------&lt;br/&gt;   e_no                     number;&lt;br/&gt;   e_mail                   varchar2(100);&lt;br/&gt;   dept_pro                 clob:=&apos;&apos;;&lt;br/&gt;   department_pro           clob:=&apos;&apos;;&lt;br/&gt;   temp1                    clob;&lt;br/&gt;   temp2                    clob;&lt;br/&gt;   temp3                    clob:=&apos;&apos;;&lt;br/&gt;   temp4                    clob:=&apos;&apos;;   &lt;br/&gt;   m_id                     number ; &lt;br/&gt;   v_count                  number ;&lt;br/&gt;    &lt;br/&gt;begin &lt;br/&gt;&lt;br/&gt;    DBMS_LOB.createtemporary (temp1 , TRUE);  &lt;br/&gt;    DBMS_LOB.createtemporary (temp2 , TRUE);  &lt;br/&gt;    DBMS_LOB.createtemporary (temp3 , TRUE);&lt;br/&gt;    DBMS_LOB.createtemporary (temp4 , TRUE);&lt;br/&gt;    &lt;br/&gt;    ------------- 1 Day  --------------------------------------------------------------------------------------------------------------------------                                            &lt;br/&gt;    for i in dept1  loop&lt;br/&gt;           &lt;br/&gt;        department_pro :=&apos;&apos;;&lt;br/&gt;        dept_pro :=&apos;&apos;;&lt;br/&gt;        temp1 :=&apos;&apos;;&lt;br/&gt;        temp2 :=&apos;&apos;;       &lt;br/&gt;        temp3 :=&apos;&apos;;&lt;br/&gt;        temp4 :=&apos;&apos;;&lt;br/&gt;        &lt;br/&gt;        department_pro :=&apos;&lt;table width=&quot;100%&quot; border=&quot;1&quot; bordercolor=&quot;#000000&quot; style=&quot;border-collapse:collapse;&quot;&gt;&apos;;         &lt;br/&gt;                &lt;br/&gt;        for ii in ( select dept_code, department_name dept_name&lt;br/&gt;                    from OSD.MAIL_HOUR1 m, main.departments d &lt;br/&gt;                    where m.dept_code = d.department_no &lt;br/&gt;                    and m.department_no = i.department_no&lt;br/&gt;                    group by m.dept_code, department_name&lt;br/&gt;                    order by 1, dept_code  )&lt;br/&gt;&lt;br/&gt;         loop &lt;br/&gt;           &lt;br/&gt;            dept_pro :=&apos;&apos;;&lt;br/&gt;            dept_pro :=&apos;&lt;table width=&quot;100%&quot; border=&quot;1&quot; bordercolor=&quot;#000000&quot; style=&quot;border-collapse:collapse;&quot;&gt;&apos;;             &lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;            ---------- department_pro ------------&lt;br/&gt;            temp1 := &apos; &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #ddd&quot; colspan=&quot;2&quot; valign=&quot;center&quot;&gt; ??????? ?????? ????? :&apos;||ii.dept_name||&apos;&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&lt;br/&gt;                       &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #eee&quot;&gt;??? ?????&lt;/th&gt;&lt;th style=&quot;background: #eee&quot;&gt;???????&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&apos;; &lt;br/&gt;            dbms_lob.append(department_pro,temp1); &lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;            ---------- dept_pro ------------&lt;br/&gt;            temp2 := &apos; &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #ddd&quot; colspan=&quot;2&quot; valign=&quot;center&quot;&gt; ??????? ?????? ????? :&apos;||ii.dept_name||&apos;&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&lt;br/&gt;                       &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #eee&quot;&gt;??? ?????&lt;/th&gt;&lt;th style=&quot;background: #eee&quot;&gt;???????&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&apos;;&lt;br/&gt;            dbms_lob.append(dept_pro, temp2);&lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;            ------------  process_no data ----------------------------------&lt;br/&gt;            for iii in (select process_no, subject&lt;br/&gt;                        from OSD.MAIL_HOUR1 m, main.departments d &lt;br/&gt;                        where m.dept_code = d.department_no &lt;br/&gt;                        and m.dept_code = ii.dept_code&lt;br/&gt;                        and m.department_no = i.department_no&lt;br/&gt;                        order by 1 )&lt;br/&gt;             loop   &lt;br/&gt;                 &lt;br/&gt;                 temp3 := &apos; &lt;tr&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.process_no||&apos; &lt;/td&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.subject||&apos; &lt;/td&gt;&lt;br/&gt;                            &lt;/tr&gt; &apos;;                                                                                                               &lt;br/&gt;                 dbms_lob.append(department_pro, temp3);  &lt;br/&gt;&lt;br/&gt;                         &lt;br/&gt;                 temp4 := &apos; &lt;tr&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.process_no||&apos; &lt;/td&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.subject||&apos; &lt;/td&gt;&lt;br/&gt;                            &lt;/tr&gt; &apos;;&lt;br/&gt;                 dbms_lob.append(dept_pro, temp4);&lt;br/&gt;                                                                 &lt;br/&gt;                 update osd.process_status set mail_flag = 1 where process_no = iii.process_no;  &lt;br/&gt;&lt;br/&gt;             end loop;  -- iii -----------------------------------------------------------------&lt;br/&gt;            &lt;br/&gt;            dept_pro  := dept_pro||&apos;&lt;/table&gt;&apos;;&lt;br/&gt;            &lt;br/&gt;            ---------- dept_code send ------------            &lt;br/&gt;            for xx in ( select emp_no, emp_mail   into e_no, e_mail &lt;br/&gt;                        from hrms.imarah_email &lt;br/&gt;                        where nvl(emp_no,0) in  ( select employee_no &lt;br/&gt;                                                  from hrms.employees  &lt;br/&gt;                                                  where current_dept = ii.dept_code&lt;br/&gt;                                                  and postion_type = 6 -- ???? ?????   &lt;br/&gt;                                                  and emp_last_status not in (16,17)))  -- ????? ?? ????? ?????  &lt;br/&gt;             loop&lt;br/&gt;             &lt;br/&gt;               lock table p9.mailer IN  EXCLUSIVE  MODE;&lt;br/&gt;               select max(id)+1  into  m_id&lt;br/&gt;               from p9.mailer;&lt;br/&gt;                &lt;br/&gt;               insert into p9.mailer&lt;br/&gt;                        (id,   m_date, employee_no,         type,       email_to,                   subject,                  message, status)&lt;br/&gt;                 values (m_id,  sysdate, nvl(xx.emp_no,0),  &apos;Dept1&apos;,    nvl(xx.emp_mail,&apos;@&apos;),     &apos;??????? ?? ????? ???1???&apos;, &lt;br/&gt;                &apos;??? ????????? ?? ??? ??? ??????? ???? ?? ??? ??? ????? ???  &apos;||&lt;br/&gt;                chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||dept_pro , 1);&lt;br/&gt;                   &lt;br/&gt;                commit; &lt;br/&gt;                &lt;br/&gt;             end loop;     &lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;         end loop; -- ii ----------------------------------------------------------------------------------&lt;br/&gt;         &lt;br/&gt;         department_pro := department_pro||&apos;&lt;/table&gt;&apos;;            &lt;br/&gt;&lt;br/&gt;        ------------ department send ---------------                  &lt;br/&gt;        select count(*) into v_count &lt;br/&gt;        from osd.mail_hour11 -- this view just for count &lt;br/&gt;        where department_no = i.department_no;&lt;br/&gt;         &lt;br/&gt;        if v_count &gt; 0 then&lt;br/&gt;            for x in ( select emp_no, emp_mail   into e_no, e_mail &lt;br/&gt;                       from hrms.imarah_email &lt;br/&gt;                       where nvl(emp_no,0) in  ( select employee_no &lt;br/&gt;                                                 from hrms.employees  &lt;br/&gt;                                                 where current_dept = i.department_no  &lt;br/&gt;                                                 and postion_type = 6 -- ???? ?????   &lt;br/&gt;                                                 and emp_last_status not in (16,17)))  &lt;br/&gt;             loop&lt;br/&gt;&lt;br/&gt;               lock table p9.mailer IN  EXCLUSIVE  MODE;&lt;br/&gt;               select max(id)+1  into  m_id&lt;br/&gt;               from p9.mailer;&lt;br/&gt;               &lt;br/&gt;               insert into p9.mailer&lt;br/&gt;                        (id,   m_date, employee_no,         type,       email_to,                   subject,                  message, status)&lt;br/&gt;                 values (m_id,  sysdate, nvl(x.emp_no,0),    &apos;Depart1&apos;,  nvl(x.emp_mail,&apos;@&apos;),        &apos;??????? ?? ????? ???1???&apos;, &lt;br/&gt;                &apos;??? ????????? ?? ??? ??? ??????? ???? ?? ??? ??? ????? ???  &apos;||&lt;br/&gt;                chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||department_pro , 1);&lt;br/&gt;                   &lt;br/&gt;                commit; &lt;br/&gt;                &lt;br/&gt;             end loop;     &lt;br/&gt;            &lt;br/&gt;            ----  yahya email &lt;br/&gt;            lock table p9.mailer IN   EXCLUSIVE  MODE;&lt;br/&gt;            select max(id)+1  into  m_id&lt;br/&gt;            from p9.mailer;&lt;br/&gt;            &lt;br/&gt;            insert into p9.mailer&lt;br/&gt;                    (id,   m_date, employee_no,         type,          email_to,                   subject,                  message, status)&lt;br/&gt;            values  (m_id,  sysdate, 0,                 &apos;Depart1&apos;,  &apos;yjabri@makkah.gov.sa&apos;,        &apos;??????? ?? ????? ???1???&apos;, &lt;br/&gt;            &apos;??? ????????? ?? ??? ??? ??????? ???? ?? ??? ??? ????? ???  &apos;||&lt;br/&gt;            chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||department_pro , 0);&lt;br/&gt;            &lt;br/&gt;            commit;&lt;br/&gt;            &lt;br/&gt;        end if;&lt;br/&gt;        &lt;br/&gt;    end loop;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;    ------------- 2 Days ------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;       &lt;br/&gt;    for i in dept2  loop&lt;br/&gt;         &lt;br/&gt;        department_pro :=&apos;&apos;;&lt;br/&gt;        dept_pro :=&apos;&apos;;&lt;br/&gt;        temp1 :=&apos;&apos;;&lt;br/&gt;        temp2 :=&apos;&apos;;       &lt;br/&gt;        temp3 :=&apos;&apos;;&lt;br/&gt;        temp4 :=&apos;&apos;;&lt;br/&gt;        &lt;br/&gt;        department_pro :=&apos;&lt;table width=&quot;100%&quot; border=&quot;1&quot; bordercolor=&quot;#000000&quot; style=&quot;border-collapse:collapse;&quot;&gt;&apos;;         &lt;br/&gt;                &lt;br/&gt;        for ii in ( select dept_code, department_name dept_name&lt;br/&gt;                    from OSD.MAIL_HOUR2 m, main.departments d &lt;br/&gt;                    where m.dept_code = d.department_no &lt;br/&gt;                    and m.department_no = i.department_no&lt;br/&gt;                    group by m.dept_code, department_name&lt;br/&gt;                    order by 1, dept_code  )&lt;br/&gt;&lt;br/&gt;         loop &lt;br/&gt;           &lt;br/&gt;            dept_pro :=&apos;&apos;;&lt;br/&gt;            dept_pro :=&apos;&lt;table width=&quot;100%&quot; border=&quot;1&quot; bordercolor=&quot;#000000&quot; style=&quot;border-collapse:collapse;&quot;&gt;&apos;;             &lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;            ---------- department_pro ------------&lt;br/&gt;            temp1 := &apos; &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #ddd&quot; colspan=&quot;2&quot; valign=&quot;center&quot;&gt; ??????? ?????? ????? :&apos;||ii.dept_name||&apos;&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&lt;br/&gt;                       &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #eee&quot;&gt;??? ?????&lt;/th&gt;&lt;th style=&quot;background: #eee&quot;&gt;???????&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&apos;; &lt;br/&gt;            dbms_lob.append(department_pro,temp1); &lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;            ---------- dept_pro ------------&lt;br/&gt;            temp2 := &apos; &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #ddd&quot; colspan=&quot;2&quot; valign=&quot;center&quot;&gt; ??????? ?????? ????? :&apos;||ii.dept_name||&apos;&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&lt;br/&gt;                       &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #eee&quot;&gt;??? ?????&lt;/th&gt;&lt;th style=&quot;background: #eee&quot;&gt;???????&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&apos;;&lt;br/&gt;            dbms_lob.append(dept_pro, temp2);&lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;                ------------  process_no data ----------------------------------&lt;br/&gt;                for iii in (select process_no, subject&lt;br/&gt;                            from OSD.MAIL_HOUR2 m, main.departments d &lt;br/&gt;                            where m.dept_code = d.department_no &lt;br/&gt;                            and m.dept_code = ii.dept_code&lt;br/&gt;                            and m.department_no = i.department_no&lt;br/&gt;                            order by 1 )&lt;br/&gt;                loop   &lt;br/&gt;                 &lt;br/&gt;                 temp3 := &apos; &lt;tr&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.process_no||&apos; &lt;/td&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.subject||&apos; &lt;/td&gt;&lt;br/&gt;                            &lt;/tr&gt; &apos;;                                                                                                               &lt;br/&gt;                  dbms_lob.append(department_pro, temp3);  &lt;br/&gt;&lt;br/&gt;                     &lt;br/&gt;                  temp4 := &apos; &lt;tr&gt;&lt;br/&gt;                                &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.process_no||&apos; &lt;/td&gt;&lt;br/&gt;                                &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.subject||&apos; &lt;/td&gt;&lt;br/&gt;                             &lt;/tr&gt; &apos;;&lt;br/&gt;                   dbms_lob.append(dept_pro, temp4);&lt;br/&gt;                                             &lt;br/&gt;                             &lt;br/&gt;                   update osd.process_status set mail_flag = 2 where process_no = iii.process_no;  &lt;br/&gt;&lt;br/&gt;                end loop;  -- iii -----------------------------------------------------------------&lt;br/&gt;            &lt;br/&gt;             dept_pro  := dept_pro||&apos;&lt;/table&gt;&apos;;&lt;br/&gt;            &lt;br/&gt;            ---------- dept_code send ------------                       &lt;br/&gt;            for xx in ( select emp_no, emp_mail   into e_no, e_mail &lt;br/&gt;                        from hrms.imarah_email &lt;br/&gt;                        where nvl(emp_no,0) in  ( select employee_no from hrms.employees &lt;br/&gt;                                                  where current_dept = ii.dept_code&lt;br/&gt;                                                  and postion_type in (6,10) -- ???? ????? ? ???? ??? &lt;br/&gt;                                                  and emp_last_status not in (16,17) )) &lt;br/&gt;            loop&lt;br/&gt;&lt;br/&gt;               lock table p9.mailer IN   EXCLUSIVE  MODE;&lt;br/&gt;               select max(id)+1  into  m_id&lt;br/&gt;               from p9.mailer;&lt;br/&gt;               &lt;br/&gt;               insert into p9.mailer &lt;br/&gt;                       (id,   m_date, employee_no,          type,       email_to,               subject,                   message, status)&lt;br/&gt;               values  (m_id, sysdate, nvl(xx.emp_no,0),    &apos;Dept2&apos;,     nvl(xx.emp_mail,&apos;@&apos;),    &apos;??????? ?? ????? ???2???&apos;, &lt;br/&gt;               &apos;??? ????????? ??? ??? ??????? ???? ?? ????? ??? ????? ???  ?????? ???? ?????? ???????? ??? ?????? ???? ????  &apos;||&lt;br/&gt;               chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||dept_pro , 1);&lt;br/&gt;               &lt;br/&gt;               commit;   &lt;br/&gt;                                                 &lt;br/&gt;            end loop;&lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;         end loop;&lt;br/&gt;         &lt;br/&gt;         department_pro := department_pro||&apos;&lt;/table&gt;&apos;;            &lt;br/&gt;&lt;br/&gt;        ------------ department send ---------------                        &lt;br/&gt;        select count(*) into v_count &lt;br/&gt;        from osd.mail_hour22 -- this view just for count &lt;br/&gt;        where department_no = i.department_no;&lt;br/&gt;         &lt;br/&gt;        if v_count &gt; 0 then&lt;br/&gt;            &lt;br/&gt;            for xx in ( select emp_no, emp_mail   into e_no, e_mail &lt;br/&gt;                        from hrms.imarah_email &lt;br/&gt;                        where nvl(emp_no,0) in  ( select employee_no from hrms.employees &lt;br/&gt;                                                  where current_dept = i.department_no&lt;br/&gt;                                                  and postion_type in (6,10) -- ???? ????? ? ???? ??? &lt;br/&gt;                                                  and emp_last_status not in (16,17) )) &lt;br/&gt;            loop&lt;br/&gt;               &lt;br/&gt;               lock table p9.mailer IN   EXCLUSIVE  MODE;&lt;br/&gt;               select max(id)+1  into  m_id&lt;br/&gt;               from p9.mailer;&lt;br/&gt;               &lt;br/&gt;               insert into p9.mailer &lt;br/&gt;                       (id,   m_date, employee_no,          type,       email_to,               subject,                   message, status)&lt;br/&gt;               values  (m_id, sysdate, nvl(xx.emp_no,0),   &apos;Depart2&apos;,          nvl(xx.emp_mail,&apos;@&apos;),    &apos;??????? ?? ????? ???2???&apos;, &lt;br/&gt;               &apos;??? ????????? ??? ??? ??????? ???? ?? ????? ??? ????? ???  ?????? ???? ?????? ???????? ??? ?????? ???? ????  &apos;||&lt;br/&gt;               chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||department_pro , 1);&lt;br/&gt;               &lt;br/&gt;               commit;   &lt;br/&gt;                                                 &lt;br/&gt;            end loop;&lt;br/&gt;&lt;br/&gt;        &lt;br/&gt;            ----  yahya email &lt;br/&gt;            lock table p9.mailer IN   EXCLUSIVE  MODE;&lt;br/&gt;            select max(id)+1  into  m_id&lt;br/&gt;            from p9.mailer;&lt;br/&gt;            &lt;br/&gt;            insert into p9.mailer &lt;br/&gt;                   (id,   m_date, employee_no,          type,       email_to,               subject,                   message, status)&lt;br/&gt;            values  (m_id, sysdate, 0,                  &apos;Depart2&apos;,  &apos;YJabri@makkah.gov.sa&apos;,    &apos;??????? ?? ????? ???2???&apos;, &lt;br/&gt;            &apos;??? ????????? ??? ??? ??????? ???? ?? ????? ??? ????? ???  ?????? ???? ?????? ???????? ??? ?????? ???? ????  &apos;||&lt;br/&gt;            chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||department_pro , 0);&lt;br/&gt;            &lt;br/&gt;            commit;&lt;br/&gt;            &lt;br/&gt;        end if;&lt;br/&gt;        &lt;br/&gt;    end loop;    &lt;br/&gt;&lt;br/&gt;&lt;br/&gt;    ------------- 3 Days ------------------------------------------------------------------------------------------------------------------------------&lt;br/&gt;    &lt;br/&gt;    for i in dept3  loop&lt;br/&gt;       &lt;br/&gt;        department_pro :=&apos;&apos;;&lt;br/&gt;        dept_pro :=&apos;&apos;;&lt;br/&gt;        temp1 :=&apos;&apos;;&lt;br/&gt;        temp2 :=&apos;&apos;;       &lt;br/&gt;        temp3 :=&apos;&apos;;&lt;br/&gt;        temp4 :=&apos;&apos;;&lt;br/&gt;        &lt;br/&gt;        department_pro :=&apos;&lt;table width=&quot;100%&quot; border=&quot;1&quot; bordercolor=&quot;#000000&quot; style=&quot;border-collapse:collapse;&quot;&gt;&apos;;         &lt;br/&gt;                &lt;br/&gt;        for ii in ( select dept_code, department_name dept_name&lt;br/&gt;                    from OSD.MAIL_HOUR3 m, main.departments d &lt;br/&gt;                    where m.dept_code = d.department_no &lt;br/&gt;                    and m.department_no = i.department_no&lt;br/&gt;                    group by m.dept_code, department_name&lt;br/&gt;                    order by 1, dept_code  )&lt;br/&gt;&lt;br/&gt;         loop &lt;br/&gt;           &lt;br/&gt;            dept_pro :=&apos;&apos;;&lt;br/&gt;            dept_pro :=&apos;&lt;table width=&quot;100%&quot; border=&quot;1&quot; bordercolor=&quot;#000000&quot; style=&quot;border-collapse:collapse;&quot;&gt;&apos;;             &lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;            ---------- department_pro ------------&lt;br/&gt;            temp1 := &apos; &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #ddd&quot; colspan=&quot;2&quot; valign=&quot;center&quot;&gt; ??????? ?????? ????? :&apos;||ii.dept_name||&apos;&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&lt;br/&gt;                       &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #eee&quot;&gt;??? ?????&lt;/th&gt;&lt;th style=&quot;background: #eee&quot;&gt;???????&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&apos;; &lt;br/&gt;            dbms_lob.append(department_pro,temp1); &lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;            ---------- dept_pro ------------&lt;br/&gt;            temp2 := &apos; &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #ddd&quot; colspan=&quot;2&quot; valign=&quot;center&quot;&gt; ??????? ?????? ????? :&apos;||ii.dept_name||&apos;&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&lt;br/&gt;                       &lt;tr&gt;&lt;br/&gt;                         &lt;th style=&quot;background: #eee&quot;&gt;??? ?????&lt;/th&gt;&lt;th style=&quot;background: #eee&quot;&gt;???????&lt;/th&gt;&lt;br/&gt;                       &lt;/tr&gt;&apos;;&lt;br/&gt;            dbms_lob.append(dept_pro, temp2);&lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;                ------------  process_no data ----------------------------------&lt;br/&gt;                for iii in (select process_no, subject&lt;br/&gt;                            from OSD.MAIL_HOUR3 m, main.departments d &lt;br/&gt;                            where m.dept_code = d.department_no &lt;br/&gt;                            and m.dept_code = ii.dept_code&lt;br/&gt;                            and m.department_no = i.department_no&lt;br/&gt;                            order by 1 )&lt;br/&gt;                loop   &lt;br/&gt;                 &lt;br/&gt;                 temp3 := &apos; &lt;tr&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.process_no||&apos; &lt;/td&gt;&lt;br/&gt;                               &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.subject||&apos; &lt;/td&gt;&lt;br/&gt;                            &lt;/tr&gt; &apos;;                                                                                                               &lt;br/&gt;                  dbms_lob.append(department_pro, temp3);  &lt;br/&gt;&lt;br/&gt;                     &lt;br/&gt;                  temp4 := &apos; &lt;tr&gt;&lt;br/&gt;                                &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.process_no||&apos; &lt;/td&gt;&lt;br/&gt;                                &lt;td valign=&quot;center&quot; align=&quot;center&quot;&gt; &apos;||iii.subject||&apos; &lt;/td&gt;&lt;br/&gt;                             &lt;/tr&gt; &apos;;&lt;br/&gt;                   dbms_lob.append(dept_pro, temp4);&lt;br/&gt;                                             &lt;br/&gt;                             &lt;br/&gt;                   update osd.process_status set mail_flag = 3 where process_no = iii.process_no;  &lt;br/&gt;&lt;br/&gt;                end loop;  -- iii -----------------------------------------------------------------&lt;br/&gt;            &lt;br/&gt;             dept_pro  := dept_pro||&apos;&lt;/table&gt;&apos;;&lt;br/&gt;            &lt;br/&gt;&lt;br/&gt;            ---------- dept_code send ------------                       &lt;br/&gt;             for x in ( select emp_no, emp_mail   into e_no, e_mail &lt;br/&gt;                        from hrms.imarah_email &lt;br/&gt;                        where emp_no in   ( select employee_no &lt;br/&gt;                                            from hrms.employees &lt;br/&gt;                                            where current_dept = i.department_no &lt;br/&gt;                                            and postion_type in (6, 10) -- ???? ????? ????? ??? &lt;br/&gt;                                            and emp_last_status not in (16,17) )) &lt;br/&gt;             loop&lt;br/&gt;               &lt;br/&gt;               lock table p9.mailer IN   EXCLUSIVE  MODE;&lt;br/&gt;               select max(id)+1  into  m_id&lt;br/&gt;               from p9.mailer;               &lt;br/&gt;               &lt;br/&gt;               insert into p9.mailer &lt;br/&gt;                       (id,   m_date, employee_no,       type,      email_to,               subject,                      message, status)&lt;br/&gt;               values  (m_id, sysdate, nvl(x.emp_no,0),  &apos;Dept3&apos;,        nvl(x.emp_mail,&apos;@&apos;),   &apos;??????? ?? ????? ?? 3????&apos;, &lt;br/&gt;                 &apos;??? ????????? ??? ??? ??????? ???? ?? ????? ???? ??? ????? ???  &apos;||&lt;br/&gt;                 chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||dept_pro , 1);&lt;br/&gt;                &lt;br/&gt;                commit;                                    &lt;br/&gt;              &lt;br/&gt;             end loop;&lt;br/&gt;            &lt;br/&gt;            &lt;br/&gt;         end loop;&lt;br/&gt;         &lt;br/&gt;         department_pro := department_pro||&apos;&lt;/table&gt;&apos;;            &lt;br/&gt;&lt;br/&gt;        ------------ department send ---------------                        &lt;br/&gt;        select count(*) into v_count &lt;br/&gt;        from osd.mail_hour33  -- this view just for count &lt;br/&gt;        where department_no = i.department_no;&lt;br/&gt;         &lt;br/&gt;        if v_count &gt; 0 then&lt;br/&gt;            &lt;br/&gt;             for x in ( select emp_no, emp_mail   into e_no, e_mail &lt;br/&gt;                        from hrms.imarah_email &lt;br/&gt;                        where emp_no in   ( select employee_no &lt;br/&gt;                                            from hrms.employees &lt;br/&gt;                                            where current_dept = i.department_no &lt;br/&gt;                                            and postion_type in (6, 10) -- ???? ????? ????? ??? &lt;br/&gt;                                            and emp_last_status not in (16,17) )) &lt;br/&gt;             loop&lt;br/&gt;                &lt;br/&gt;               lock table p9.mailer IN   EXCLUSIVE  MODE;&lt;br/&gt;               select max(id)+1  into  m_id&lt;br/&gt;               from p9.mailer;               &lt;br/&gt;               &lt;br/&gt;               insert into p9.mailer &lt;br/&gt;                       (id,   m_date, employee_no,       type,      email_to,               subject,                      message, status)&lt;br/&gt;               values  (m_id, sysdate, nvl(x.emp_no,0),  &apos;Depart3&apos;,  nvl(x.emp_mail,&apos;@&apos;),   &apos;??????? ?? ????? ?? 3????&apos;, &lt;br/&gt;                 &apos;??? ????????? ??? ??? ??????? ???? ?? ????? ???? ??? ????? ???  &apos;||&lt;br/&gt;                 chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||department_pro , 1);&lt;br/&gt;                &lt;br/&gt;                commit;                                    &lt;br/&gt;              &lt;br/&gt;             end loop;&lt;br/&gt;&lt;br/&gt;        &lt;br/&gt;            ----  yahya email &lt;br/&gt;            lock table p9.mailer IN   EXCLUSIVE  MODE;&lt;br/&gt;            select max(id)+1  into  m_id&lt;br/&gt;            from p9.mailer;&lt;br/&gt;            &lt;br/&gt;            insert into p9.mailer &lt;br/&gt;                   (id,   m_date, employee_no,       type,      email_to,               subject,                      message, status)&lt;br/&gt;            values  (m_id, sysdate, 0,               &apos;Depart3&apos;,       &apos;YJabri@makkah.gov.sa&apos;,   &apos;??????? ?? ????? ?? 3????&apos;, &lt;br/&gt;             &apos;??? ????????? ??? ??? ??????? ???? ?? ????? ???? ??? ????? ???  &apos;||&lt;br/&gt;            chr(10)||&apos; ??????? ??????? : &apos;||i.department_name||&apos;:- &apos;||chr(10)||chr(10)||department_pro , 0);&lt;br/&gt;           &lt;br/&gt;            commit;&lt;br/&gt;            &lt;br/&gt;        end if;&lt;br/&gt;        &lt;br/&gt;    end loop;    &lt;br/&gt;    &lt;br/&gt;end;</body>
</StoredProcedureOraclev10g>